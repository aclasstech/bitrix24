<? namespace Bitrix\Main\Security\W;$GLOBALS['____1764405750']= array(base64_decode('dGl'.'tZQ=='),base64_decode('dGltZQ='.'='),base64_decode(''.'anNv'.'bl'.'9kZWNv'.'ZGU='),base64_decode('YX'.'J'.'yYXlf'.'bWVyZ2U='),base64_decode('am9pbg'.'=='),base64_decode('am9pb'.'g'.'=='),base64_decode('am9pb'.'g=='),base64_decode('Y'.'XJy'.'YXl'.'fc'.'G9w'),base64_decode('Y'.'XJyY'.'Xlfc2hpZnQ'.'='),base64_decode(''.'YXJyYXlfc2'.'hpZnQ='),base64_decode('Y'.'X'.'JyYX'.'lfc2h'.'p'.'Zn'.'Q='),base64_decode(''.'Y'.'X'.'J'.'y'.'YXl'.'f'.'c2hpZnQ='),base64_decode('YXJyYXlfbWVyZ2U='),base64_decode('aXN'.'fYX'.'J'.'yY'.'Xk='),base64_decode('YXJyYXl'.'f'.'bWV'.'yZ2'.'U='),base64_decode(''.'aW5f'.'YXJyYXk='),base64_decode('aW5fY'.'XJyYXk='),base64_decode('aW5f'.'YXJyYXk='),base64_decode('aW5fYX'.'JyYXk='),base64_decode('aW5fYX'.'Jy'.'YXk='),base64_decode('dGltZ'.'Q'.'=='),base64_decode('dGltZQ=='),base64_decode('YX'.'JyYXlfbWFw'),base64_decode(''.'anNv'.'b'.'l9lbmNvZGU'.'='),base64_decode(''.'anNvbl9lb'.'m'.'NvZG'.'U='),base64_decode('am9pbg=='));if(!function_exists(__NAMESPACE__.'\\___459074890')){function ___459074890($_913836897){static $_234935766= false; if($_234935766 == false) $_234935766=array('V1d'.'B'.'TExfT'.'E9DSw'.'==','c2VjdXJpdHk=','Y2'.'FjaGU=','dHRs','R'.'EFUQQ'.'==',''.'eyI=','V1d'.'B'.'TExfTE9'.'DSw==','c2V'.'jdXJpdHk=',''.'U0'.'VDVVJJV'.'FlfV1dBTEx'.'fR'.'Vh'.'DRVBU'.'SU9O','RkFJTF9'.'DSEVDS0lORw'.'==','Q'.'2'.'FuI'.'G5vdCB'.'le'.'GVjdXRl'.'IHd3'.'YWxsI'.'HJ1bGVzO'.'iA=','IF'.'RyY'.'WNl'.'OiA'.'=','UkVR'.'VUVTVF'.'9'.'VU'.'k'.'k=','a'.'2V5cw'.'='.'=','dmF'.'sdWVz','U0VDVVJ'.'JVFlfV1'.'dB'.'TExfTU9E'.'SUZZ','Lg==','U0'.'VDVVJJVFlfV1dBTExfVU'.'5T'.'RVQ=','Lg==',''.'U0'.'VDVVJJVF'.'l'.'fV1dBTExfRVhJV'.'A'.'='.'=','Lg==',''.'Z2xv'.'Ym'.'Fs',''.'a2'.'V5'.'cw==',''.'dmFsdW'.'Vz',''.'Z2V'.'0','Z2V'.'0','cG9zdA==','c'.'G'.'9'.'z'.'dA==','Y2'.'9va'.'2ll','Y'.'29v'.'a2ll','cmVxd'.'WVzdA==',''.'cmVxdWVzd'.'A==',''.'Z2xvYmF'.'s','Z2x'.'vYmFs','bWFpbl9'.'z'.'ZW'.'M=','V1dBTExfQUNUVUFMSVpFX'.'1JVTEV'.'T',''.'dg==','d'.'mV'.'yc2'.'lvbg==','aQ==','aXN'.'J'.'bnN0Y'.'Wx'.'sZWQ=','c29ja2'.'V0VGltZW91dA==',''.'c3RyZWF'.'tVGl'.'t'.'ZW91dA==','KC'.'c=','ZG'.'F0YQ==',''.'JywgJ'.'w'.'==','bW'.'9kdWxl','J'.'y'.'wgJw'.'==','bW9kdWxlX3ZlcnNpb24=','Jyk'.'=','LCA'.'=','U0V'.'D'.'VVJJVFlfV1dBTExfR'.'VhDR'.'VBUSU9O',''.'bWFpb'.'g='.'=','RkFJTF9SRU'.'Z'.'SRVNI'.'SU5H','Q2FuIG5vdCByZW'.'Z'.'yZXN'.'oIHd3Y'.'Wx'.'sIHJ1bG'.'VzOiA=','I'.'FRyYWN'.'lOi'.'A'.'=','ZG'.'F0YQ==',''.'eyI=','LS'.'0tLS'.'1CRUdJ'.'Ti'.'BQVUJ'.'MSUMg'.'S0VZLS0'.'tLS0=','C'.'k1'.'JSUJJakFOQmdrc'.'W'.'hraU'.'c5'.'dzBCQVFFRkF'.'BT0'.'NBUThBT'.'Ul'.'JQk'.'NnS0NBUUVBcThRRTBIam'.'1ISlV'.'TdF'.'dWNm4we'.'mEKUl'.'ZvT'.'H'.'g'.'wMk'.'t6YmZyYlMvUDZzV2F4'.'VH'.'p'.'3'.'OFN'.'lR1R0Y'.'lRDT3JwSG'.'k1UUY2T'.'1'.'J'.'5alovWHh6L0tMVTFHYm'.'9mOUNaMwo'.'0ej'.'dT'.'a3FVdDY2aWJY'.'d'.'k'.'9G'.'Qng0ZncvQ'.'V'.'BQUkdEcXRt'.'MG5EM2ZnR'.'3N1M'.'1'.'Jl'.'UG'.'d3MjlpOCt2bTdtdEJ'.'LSlVZbDRy'.'ClZ'.'w'.'Y'.'jZ'.'zZlpFVDlLRWI2VDF'.'IRFltRXZj'.'MWhx'.'L2lp'.'dXl'.'4THJ'.'aW'.'mk1'.'UTZVZmY0VUV2V'.'EkrNj'.'hzc0Z'.'S'.'a1'.'Erb3dUUnkKZU9'.'JTW'.'JG'.'a'.'E0'.'v'.'V'.'VRt'.'ZlZ'.'ZYlR'.'SRnk'.'yb1VROFdNemEybko1U2'.'Fo'.'emk'.'xV'.'Ut'.'PMWpBalhUU'.'FJy'.'emM'.'3'.'QWp1NjM5ajFPMApwcH'.'FmbTV4Z1'.'dsRkFK'.'a0hRVGdiZGQ'.'1QVdxR'.'EZR'.'a'.'3Q5'.'SEtrWStU'.'bm'.'ZCTEdWTXZ'.'WeVB'.'3VE'.'hOV'.'1FZQXc0'.'eHBnL3dBClp'.'3SUR'.'BUUFCCi0'.'tLS0tR'.'U5EIFB'.'VQkxJQyB'.'LRVktLS0tLQ='.'=');return base64_decode($_234935766[$_913836897]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; class WWall{ const CACHE_RULES_TTL= 10800; private static $_833765409= 'https://wwall.bitrix.info/rules.php'; protected $_164100703= true; public function handle(){ try{  $_791660876= Cache::createInstance(); $_1370497309= false; if($_791660876->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_543256010= $_791660876->getVars(); if($GLOBALS['____1764405750'][0]()- $_543256010> round(0+10+10)){  $_246844255= Application::getConnection(); $_19908447= RuleRecordTable::getTableName(); $_246844255->truncateTable($_19908447); RuleRecordTable::cleanCache(); $_791660876->clean(___459074890(0), ___459074890(1));}} elseif($_791660876->startDataCache()){  $_791660876->endDataCache($GLOBALS['____1764405750'][1]()); $_1370497309= true;}  $_1480723501= RuleRecordTable::getList([ ___459074890(2) =>[___459074890(3) => round(0+1800+1800)* round(0+24)* round(0+1.75+1.75+1.75+1.75)]])->fetchAll(); foreach($_1480723501 as $_988524851){ $_360991980= new PublicKeyCipher; $_756057381= $_360991980->decrypt($_988524851[___459074890(4)], static::__1862782785()); if(!str_starts_with($_756057381, ___459074890(5))){ continue;} $_1821304317= $GLOBALS['____1764405750'][2]($_756057381, true); if(!empty($_1821304317)){ $_1898044827= Rule::make($_1821304317); $_1613806923= $this->handleRule($_1898044827); $this->applyHandlingResults($_1613806923);}}  if($_1370497309){ $_791660876->clean(___459074890(6), ___459074890(7));}} catch(\Throwable $_962581707){ $this->logEvent( ___459074890(8), ___459074890(9), ___459074890(10). $_962581707->getMessage(). ___459074890(11). $_962581707->getTraceAsString());}}  public function handleRule(Rule $_1898044827): array{ $_1613806923=[]; if($_1898044827->matchPath($_SERVER[___459074890(12)])){  $_1992137936= $this->getContextElements($_1898044827->getContext()); foreach($_1992137936 as $_2127903546 => &$_670145450){ $_1613806923= $GLOBALS['____1764405750'][3]($_1613806923, $this->recursiveContextKeyHandle($_2127903546, $_670145450,[], $_1898044827));}} return $_1613806923;}  public function applyHandlingResults(array $_1613806923){ $_1992137936= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1613806923 as $_1134338347){ $_670145450=& $_1992137936[$_1134338347->getContextName()]; $_152529619= $_1134338347->getRuleResult(); $_1898044827= $_1134338347->getRule(); if($_152529619 instanceof ModifyResult){ if($_1898044827->getProcess() === ___459074890(13)){  static::rewriteContextKey( $_1134338347->getContextName(), $_670145450, $_1134338347->getContextKey(), $_152529619->getCleanValue());} elseif($_1898044827->getProcess() === ___459074890(14)){ static::rewriteContextValue( $_1134338347->getContextName(), $_670145450, $_1134338347->getContextKey(), $_152529619->getCleanValue());} $this->logEvent( ___459074890(15), $_1134338347->getContextName(), $GLOBALS['____1764405750'][4](___459074890(16), $_1134338347->getContextKey()));} elseif($_152529619 instanceof CheckResult &&!$_152529619->isSuccess()){ if($_152529619->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1134338347->getContextName(), $_670145450, $_1134338347->getContextKey(),); $this->logEvent( ___459074890(17), $_1134338347->getContextName(), $GLOBALS['____1764405750'][5](___459074890(18), $_1134338347->getContextKey()));} elseif($_152529619->getAction() === RuleAction::EXIT){ $this->logEvent( ___459074890(19), $_1134338347->getContextName(), $GLOBALS['____1764405750'][6](___459074890(20), $_1134338347->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_164100703= false;} protected function rewriteContextKey($_2127903546, &$_670145450, $_528274412, $_1883831566){ $_1573771964= $_528274412;  $GLOBALS['____1764405750'][7]($_1573771964); $_1573771964[]= $_1883831566; if($_2127903546 === ___459074890(21)){ $_56201111= $GLOBALS['____1764405750'][8]($_528274412); $GLOBALS['____1764405750'][9]($_1573771964); if(empty($_528274412)){ $GLOBALS[$_1883831566]= $GLOBALS[$_56201111]; unset($GLOBALS[$_56201111]);} else{ $_670145450=& $GLOBALS[$_56201111]; $_1099825335= ArrayHelper::getByNestedKey($_670145450, $_528274412);  ArrayHelper::setByNestedKey($_670145450, $_1573771964, $_1099825335);  ArrayHelper::unsetByNestedKey($_670145450, $_528274412);}} else{ $_1099825335= ArrayHelper::getByNestedKey($_670145450, $_528274412);  ArrayHelper::setByNestedKey($_670145450, $_1573771964, $_1099825335);  ArrayHelper::unsetByNestedKey($_670145450, $_528274412);}} protected function rewriteContextValue($_2127903546, &$_670145450, $_1308671308, $_1099825335){ if($_2127903546 === 'global'){ $_56201111= $GLOBALS['____1764405750'][10]($_1308671308); if(empty($_1308671308)){ $GLOBALS[$_56201111]= $_1099825335;} else{ $_670145450=& $GLOBALS[$_56201111]; ArrayHelper::setByNestedKey($_670145450, $_1308671308, $_1099825335);}} else{  ArrayHelper::setByNestedKey($_670145450, $_1308671308, $_1099825335);}} protected function unsetContextValue($_2127903546, &$_670145450, $_1308671308){ if($_2127903546 === 'global'){ $_56201111= $GLOBALS['____1764405750'][11]($_1308671308); if(empty($_1308671308)){ unset($GLOBALS[$_56201111]);} else{ $_670145450=& $GLOBALS[$_56201111]; ArrayHelper::unsetByNestedKey($_670145450, $_1308671308);}} else{ ArrayHelper::unsetByNestedKey($_670145450, $_1308671308);}}  protected function recursiveContextKeyHandle(string $_2127903546, array &$_670145450, array $_403409463, Rule $_1898044827): array{  $_1613806923=[]; foreach($_670145450 as $_873583323 => $_1099825335){ $_1308671308= $GLOBALS['____1764405750'][12]($_403409463,[$_873583323]); if($_1898044827->matchKey($_1308671308)){  if($_1898044827->getProcess() === ___459074890(22)){ $_152529619= $_1898044827->evaluate($_873583323);} elseif($_1898044827->getProcess() === ___459074890(23)){ $_152529619= $_1898044827->evaluateValue($_1099825335);}  if(!empty($_152529619) && $_152529619 instanceof RuleResult){ $_1613806923[]= new HandlingResult($_2127903546, $_1308671308, $_152529619, $_1898044827);}}  if($GLOBALS['____1764405750'][13]($_1099825335)){ $_1613806923= $GLOBALS['____1764405750'][14]($_1613806923, $this->recursiveContextKeyHandle( $_2127903546, $_670145450[$_873583323], $_1308671308, $_1898044827));}} return $_1613806923;} protected function getContextElements(array $_1188022096){ $_1358305985=[]; if($GLOBALS['____1764405750'][15](___459074890(24), $_1188022096, true)){ $_1358305985[___459074890(25)]= &$_GET;} if($GLOBALS['____1764405750'][16](___459074890(26), $_1188022096, true)){ $_1358305985[___459074890(27)]= &$_POST;} if($GLOBALS['____1764405750'][17](___459074890(28), $_1188022096, true)){ $_1358305985[___459074890(29)]= &$_COOKIE;} if($GLOBALS['____1764405750'][18](___459074890(30), $_1188022096, true)){ $_1358305985[___459074890(31)]= &$_REQUEST;} if($GLOBALS['____1764405750'][19](___459074890(32), $_1188022096, true)){ $_1358305985[___459074890(33)]= $GLOBALS;} return $_1358305985;} public static function refreshRules(){ try{ $_1301467396= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1764405750'][20]()- $_1301467396)< static::CACHE_RULES_TTL){ return;} Option::set(___459074890(34), ___459074890(35), $GLOBALS['____1764405750'][21]()); $_532741730= null;  $_404904372= $GLOBALS['____1764405750'][22](function($_632194050){ return[___459074890(36) => $_632194050[___459074890(37)], ___459074890(38) => (int) $_632194050[___459074890(39)]];}, ModuleManager::getModulesFromDisk());  $_2039440380= new HttpClient([ ___459074890(40) => round(0+1+1+1+1+1), ___459074890(41) => round(0+5)]); $_417634535= $_2039440380->post( static::$_833765409,[ 'modules' => $GLOBALS['____1764405750'][23]($_404904372), 'license' => Application::getInstance()->getLicense()->getHashLicenseKey()]); if($_2039440380->getStatus() == round(0+40+40+40+40+40) &&!empty($_417634535)){ $_532741730= Json::decode($_417634535);}  if($_532741730 !== null){ $_246844255= Application::getConnection(); $_19908447= RuleRecordTable::getTableName(); if(!empty($_532741730)){ foreach($_532741730 as $_594495177){ if(!static::checkRuleSign($_594495177)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1764405750'][24]($_594495177));}}}  $_246844255->truncateTable($_19908447);  if(!empty($_532741730)){ $_2005306573=[]; foreach($_532741730 as $_594495177){ $_2005306573[]= ___459074890(42). $_246844255->getSqlHelper()->forSql($_594495177[___459074890(43)]). ___459074890(44). $_246844255->getSqlHelper()->forSql($_594495177[___459074890(45)]). ___459074890(46). $_246844255->getSqlHelper()->forSql($_594495177[___459074890(47)]). ___459074890(48);} $_791755869= $GLOBALS['____1764405750'][25](___459074890(49), $_2005306573);  $_246844255->query("INSERT INTO {$_19908447} (DATA, MODULE, MODULE_VERSION) VALUES {$_791755869}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_962581707){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___459074890(50), ___459074890(51), ___459074890(52), ___459074890(53). $_962581707->getMessage(). ___459074890(54). $_962581707->getTraceAsString());}} protected static function checkRuleSign($_1898044827){ $_360991980= new PublicKeyCipher; $_1821304317= $_360991980->decrypt($_1898044827[___459074890(55)], static::__1862782785()); return str_starts_with($_1821304317, ___459074890(56));} private static function __1862782785(){ $_1279441792= ''; $_1279441792 .= ___459074890(57); $_1279441792 .= ___459074890(58); return $_1279441792;} protected function logEvent($_1209370744, $_2090998007, $_1068531731){ if($this->_164100703){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1209370744, 'main', $_2090998007, $_1068531731);}}}?>